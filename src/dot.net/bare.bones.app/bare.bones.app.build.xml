<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <BareBonesSolutionDir>$(MSBuildProjectDirectory)\</BareBonesSolutionDir>
    <BareBonesSolution>$(BareBonesSolutionDir)bare.bones.app.sln</BareBonesSolution>
    <RootDir>$(MSBuildProjectDirectory)\..\..\..\</RootDir>
    <BuildArtifactsDir>$(RootDir)build.artifacts\</BuildArtifactsDir>
    <BareBonesBuildArtifactsDir>$(BuildArtifactsDir)bare.bones.app\</BareBonesBuildArtifactsDir>
    <BareBonesFullBuildArtifactsDir>$(BareBonesBuildArtifactsDir)full\</BareBonesFullBuildArtifactsDir>
    <BareBonesDeployBuildArtifactsDir>$(BareBonesBuildArtifactsDir)deploy\</BareBonesDeployBuildArtifactsDir>
    <BareBonesBuildDocumentationDir>$(BareBonesBuildArtifactsDir)build.docs\</BareBonesBuildDocumentationDir>
    <LibDir>$(RootDir)lib\</LibDir>
    <LibTestDir>$(LibDir)test\</LibTestDir>
    <LibBuildDir>$(LibDir)build\</LibBuildDir>
    <TestDox>$(LibBuildDir)testdox\testdox.exe</TestDox>
    <NUnitExe>$(LibTestdir)nunit\nunit-console.exe</NUnitExe>
    <BareBonesProjTestAssembly>$(BareBonesFullBuildArtifactsDir)bare.bones.proj.test.dll</BareBonesProjTestAssembly>
    <BareBonesAppAcceptanceTestAssembly>$(BareBonesFullBuildArtifactsDir)bare.bones.app.acceptance.tests.dll</BareBonesAppAcceptanceTestAssembly>
  </PropertyGroup>
  <PropertyGroup>
    <WixProject>$(SolutionDir)bare.bones.install.wxs</WixProject>
    <WixObjFile>$(BareBonesFullBuildArtifactsDir)bare.bones.wixobj</WixObjFile>
    <WixToolPath>$(RootDir)lib\build\WiX\</WixToolPath>
    <CandleExe>$(WixToolPath)candle.exe</CandleExe>
    <LightExe>$(WixToolPath)light.exe</LightExe>
  </PropertyGroup>

  <Target Name="InitialisePaths">
    <ConvertToAbsolutePath Paths="$(RootDir)" AbsolutePaths="RootDir" />
  </Target>

  <Target Name="AllStages">
    <CallTarget Targets="InitialisePaths" />
    <CallTarget Targets="PrepareArtifactsDir" />
    <CallTarget Targets="BuildAll" />
    <!--<CallTarget Targets="GenerateUnitTestDocumentation" />-->
    <CallTarget Targets="RunCommitStageTests" />
    <CallTarget Targets="BuildInstaller" />
    <CallTarget Targets="RunAcceptanceStageTests" />
  </Target>

  <Target Name="BuildAll">
    <MSBuild Projects="$(BareBonesSolution)" Properties="OutputPath=$(BareBonesFullBuildArtifactsDir)" />
  </Target>

  <Target Name="GenerateUnitTestDocumentation">
    <Exec Command="$(TestDox) /Path:$(BareBonesProjTestAssembly) /Out:$(BareBonesBuildDocumentationDir)" />
  </Target>

  <Target Name="RunCommitStageTests">
    <Exec Command="$(NUnitExe) $(BareBonesProjTestAssembly) /noshadow /include:commit.stage" />
  </Target>

  <Target Name="RunAcceptanceStageTests">
    <Exec Command="$(NUnitExe) $(BareBonesAppAcceptanceTestAssembly) /noshadow /include:acceptance.stage" />
  </Target>

  <Target Name="PrepareArtifactsDir">
    <ItemGroup>
      <BuildArtifactsDirFiles Include="$(BareBonesFullBuildArtifactsDir)*" />
      <BuildArtifactsDirFiles Include="$(BareBonesDeployBuildArtifactsDir)*" />
      <BuildArtifactsDirFiles Include="$(BareBonesBuildDocumentationDir)*" />
    </ItemGroup>
    <Delete Files="@(BuildArtifactsDirFiles)" />
    <RemoveDir Condition="Exists('$(BuildArtifactsDir)')" Directories="$(BuildArtifactsDir)" />
    <RemoveDir Condition="Exists('$(BareBonesBuildArtifactsDir)')" Directories="$(BareBonesBuildArtifactsDir)" />
    <RemoveDir Condition="Exists('$(BareBonesFullBuildArtifactsDir)')" Directories="$(BareBonesFullBuildArtifactsDir)" />
    <RemoveDir Condition="Exists('$(BareBonesDeployBuildArtifactsDir)')" Directories="$(BareBonesDeployBuildArtifactsDir)" />
    <RemoveDir Condition="Exists('$(BareBonesBuildDocumentationDir)')" Directories="$(BareBonesBuildDocumentationDir)" />
    <MakeDir Condition="!Exists('$(BuildArtifactsDir)')" Directories="$(BuildArtifactsDir)" />
    <MakeDir Condition="!Exists('$(BareBonesBuildArtifactsDir)')" Directories="$(BareBonesBuildArtifactsDir)" />
    <MakeDir Condition="!Exists('$(BareBonesFullBuildArtifactsDir)')" Directories="$(BareBonesFullBuildArtifactsDir)" />
    <MakeDir Condition="!Exists('$(BareBonesDeployBuildArtifactsDir)')" Directories="$(BareBonesDeployBuildArtifactsDir)" />
    <MakeDir Condition="!Exists('$(BareBonesBuildDocumentationDir)')" Directories="$(BareBonesBuildDocumentationDir)" />
  </Target>

  <Target Name="BuildInstaller">
    <Exec Command="$(CandleExe) $(WixProject) -o $(WixObjFile)" />
    <Exec Command="$(LightExe) -b .\ -o $(BareBonesDeployBuildArtifactsDir)blah $(WixObjFile)"/>
  </Target>
  
</Project>